include(ExternalProject)

set(LIB_SOURCE_HOST "http://sdkbinaries-ws.tonlabs.io/")
set(LIB_PREFIX "tonclient_${TC_VERSION_MAJOR}_${TC_VERSION_MINOR}_${TC_VERSION_PATCH}${TC_VERSION_SUFFIX}")
set(LIB_DOWNLOAD_DIR ${CMAKE_BINARY_DIR}/lib)

function(ton_copy_lib LIB_SUFFIX LIB_EXT)
    # FIXME: not working on Windows because it doesn't know how to extract .gz files!
    # FIXME: Falling back to storing binaries in lib folder
    set(LIB_ARCHIVE_BASENAME "${LIB_PREFIX}_${LIB_SUFFIX}")
    #    set(LIB_ARCHIVE_NAME "${LIB_ARCHIVE_BASENAME}.gz")
    #    set(LIB_URL "${LIB_SOURCE_HOST}${LIB_ARCHIVE_NAME}")
    #    set(LIB_ARCHIVE "${LIB_DOWNLOAD_DIR}/${LIB_ARCHIVE_NAME}")
    set(LIB_FILE_NAME "ton_client${LIB_EXT}")
    set(LIB_FILE "${TC_LIB_DIR}/${LIB_FILE_NAME}")
    #    message(STATUS "Downloading ${LIB_URL} into ${LIB_ARCHIVE}")
    #    if (NOT EXISTS ${LIB_FILE})
    #        file(DOWNLOAD ${LIB_URL} ${LIB_ARCHIVE} TLS_VERIFY ON)
    #        file(ARCHIVE_EXTRACT INPUT ${LIB_ARCHIVE} DESTINATION ${LIB_FILE} LIST_ONLY)
    #    endif ()
    message(STATUS "Copying ${LIB_ARCHIVE_BASENAME} to ${LIB_FILE}")
    file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/${LIB_ARCHIVE_BASENAME} DESTINATION ${TC_LIB_DIR})
    file(RENAME ${TC_LIB_DIR}/${LIB_ARCHIVE_BASENAME} ${LIB_FILE})
endfunction()

if (UNIX)
    if (APPLE)
        message(STATUS "Downloading tonclient.dylib")
        ton_copy_lib(darwin .dylib)
    else ()
        message(STATUS "Downloading tonclient.so")
        ton_copy_lib(linux .so)
    endif ()
elseif (WIN32)
    message(STATUS "Downloading tonclient.dll and tonclient.lib")
    ton_copy_lib(win32_lib .lib)
    ton_copy_lib(win32_dll .dll)
endif ()

file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/tonclient.h DESTINATION ${TC_LIB_DIR})